<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex API Server - Live Testing</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .pair-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #007acc; }
        .price-display { font-size: 18px; font-weight: bold; color: #28a745; }
        .test-btn { background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #0056b3; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
        .json-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .controls { margin-bottom: 20px; }
        .pair-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Forex API Server - Live Testing</h1>
        <p>Real-time forex data API powered by Netlify Functions</p>
    </div>

    <div class="controls">
        <button class="test-btn" onclick="testAllEndpoints()">üß™ Test All Endpoints</button>
        <button class="test-btn" onclick="startLivePrices()">üìà Start Live Prices</button>
        <button class="test-btn" onclick="stopLivePrices()">‚èπÔ∏è Stop Live Prices</button>
        <button class="test-btn" onclick="generateApiKey()">üîë Generate API Key</button>
    </div>

    <div class="container">
        <div class="panel">
            <h2>üì° API Endpoints Testing</h2>
            <div id="endpoint-results"></div>
        </div>

        <div class="panel">
            <h2>üí± Live Currency Pairs</h2>
            <div class="pair-grid" id="currency-pairs"></div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>üìä JSON Response Output</h2>
        <div class="json-output" id="json-output">Waiting for API responses...</div>
    </div>

    <script>
        const pairs = [
            { symbol: 'FOREXCOM:EURUSD', metal: 'EUR', currency: 'USD', exchange: 'FOREXCOM', basePrice: 1.0850 },
            { symbol: 'FOREXCOM:GBPUSD', metal: 'GBP', currency: 'USD', exchange: 'FOREXCOM', basePrice: 1.2650 },
            { symbol: 'FOREXCOM:USDJPY', metal: 'USD', currency: 'JPY', exchange: 'FOREXCOM', basePrice: 149.50 },
            { symbol: 'FOREXCOM:AUDUSD', metal: 'AUD', currency: 'USD', exchange: 'FOREXCOM', basePrice: 0.6750 },
            { symbol: 'FOREXCOM:USDCAD', metal: 'USD', currency: 'CAD', exchange: 'FOREXCOM', basePrice: 1.3450 },
            { symbol: 'FOREXCOM:USDCHF', metal: 'USD', currency: 'CHF', exchange: 'FOREXCOM', basePrice: 0.8950 },
            { symbol: 'FOREXCOM:NZDUSD', metal: 'NZD', currency: 'USD', exchange: 'FOREXCOM', basePrice: 0.6150 },
            { symbol: 'FOREXCOM:EURGBP', metal: 'EUR', currency: 'GBP', exchange: 'FOREXCOM', basePrice: 0.8580 },
            { symbol: 'FOREXCOM:EURJPY', metal: 'EUR', currency: 'JPY', exchange: 'FOREXCOM', basePrice: 162.30 },
            { symbol: 'FOREXCOM:GBPJPY', metal: 'GBP', currency: 'JPY', exchange: 'FOREXCOM', basePrice: 189.20 },
            { symbol: 'FOREXCOM:XAUUSD', metal: 'XAU', currency: 'USD', exchange: 'FOREXCOM', basePrice: 2670.99 },
            { symbol: 'FOREXCOM:XAGUSD', metal: 'XAG', currency: 'USD', exchange: 'FOREXCOM', basePrice: 30.85 },
            { symbol: 'BINANCE:BTCUSDT', metal: 'BTC', currency: 'USDT', exchange: 'BINANCE', basePrice: 43250.00 },
            { symbol: 'BINANCE:ETHUSDT', metal: 'ETH', currency: 'USDT', exchange: 'BINANCE', basePrice: 2650.00 }
        ];

        let priceInterval = null;
        let currentPrices = {};

        function initializePairs() {
            const container = document.getElementById('currency-pairs');
            container.innerHTML = pairs.map(pair => `
                <div class="pair-item" id="pair-${pair.symbol.replace(':', '-')}">
                    <div style="font-weight: bold; color: #007acc;">${pair.symbol}</div>
                    <div class="price-display" id="price-${pair.symbol.replace(':', '-')}">Loading...</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Exchange: ${pair.exchange}<br>
                        Last Update: <span id="time-${pair.symbol.replace(':', '-')}">--</span>
                    </div>
                </div>
            `).join('');
        }

        function generateMockPrice(pair) {
            const variation = (Math.random() - 0.5) * 0.02; // 2% variation
            const currentPrice = currentPrices[pair.symbol] || pair.basePrice;
            const newPrice = currentPrice + (currentPrice * variation);
            currentPrices[pair.symbol] = newPrice;
            
            return {
                timestamp: Math.floor(Date.now() / 1000),
                metal: pair.metal,
                currency: pair.currency,
                exchange: pair.exchange,
                symbol: pair.symbol,
                "current price": parseFloat(newPrice.toFixed(pair.symbol.includes('JPY') ? 3 : 5)),
                "running price": parseFloat(newPrice.toFixed(pair.symbol.includes('JPY') ? 3 : 5))
            };
        }

        function updatePriceDisplay(pair, priceData) {
            const priceElement = document.getElementById(`price-${pair.symbol.replace(':', '-')}`);
            const timeElement = document.getElementById(`time-${pair.symbol.replace(':', '-')}`);
            
            if (priceElement) {
                priceElement.textContent = priceData['current price'];
                priceElement.style.color = Math.random() > 0.5 ? '#28a745' : '#dc3545';
            }
            
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString();
            }
        }

        function startLivePrices() {
            if (priceInterval) clearInterval(priceInterval);
            
            updateStatus('üîÑ Connecting to backend API...', 'loading');
            
            priceInterval = setInterval(async () => {
                try {
                    // Fetch real data from backend
                    const response = await fetch('/prices');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        result.data.forEach(priceData => {
                            const pair = pairs.find(p => p.symbol === priceData.symbol);
                            if (pair) {
                                updatePriceDisplay(pair, priceData);
                            }
                        });
                        
                        // Update JSON output with latest data
                        updateJsonOutput(result.data[0]); // Show first pair's data
                        
                        // Update status only once
                        if (!document.querySelector('.success')) {
                            updateStatus('‚úÖ Live backend data connected! Updating every 1 second', 'success');
                        }
                    }
                } catch (error) {
                    updateStatus('‚ùå Backend connection failed: ' + error.message, 'error');
                    console.error('Backend error:', error);
                }
            }, 1000);
        }

        function stopLivePrices() {
            if (priceInterval) {
                clearInterval(priceInterval);
                priceInterval = null;
                updateStatus('‚èπÔ∏è Live prices stopped', 'error');
            }
        }

        function updateJsonOutput(data) {
            const output = document.getElementById('json-output');
            output.textContent = JSON.stringify(data, null, 2);
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(message, type) {
            const results = document.getElementById('endpoint-results');
            results.innerHTML = `<div class="status ${type}">${message}</div>` + results.innerHTML;
        }

        async function testAllEndpoints() {
            const endpoints = [
                { name: 'Main API', url: '/', method: 'GET' },
                { name: 'Admin Panel', url: '/admin', method: 'GET' },
                { name: 'List Keys', url: '/keys', method: 'GET' },
                { name: 'WebSocket Info', url: '/ws', method: 'GET' },
                { name: 'Health Check', url: '/health', method: 'GET' }
            ];

            updateStatus('üß™ Testing all endpoints...', 'loading');

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    const data = await response.json();
                    
                    if (response.ok) {
                        updateStatus(`‚úÖ ${endpoint.name}: Success`, 'success');
                        updateJsonOutput(data);
                    } else {
                        updateStatus(`‚ùå ${endpoint.name}: Failed (${response.status})`, 'error');
                    }
                } catch (error) {
                    updateStatus(`‚ùå ${endpoint.name}: Error - ${error.message}`, 'error');
                }
            }
        }

        async function generateApiKey() {
            try {
                updateStatus('üîë Generating new API key...', 'loading');
                
                const response = await fetch('/generate-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(`‚úÖ New API Key: ${data.apiKey}`, 'success');
                    updateJsonOutput(data);
                } else {
                    updateStatus(`‚ùå Failed to generate API key`, 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePairs();
            updateStatus('üöÄ Forex API Testing Interface Ready!', 'success');
            
            // Test health endpoint on load
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    updateStatus('‚úÖ API is healthy and running!', 'success');
                    updateJsonOutput(data);
                })
                .catch(error => {
                    updateStatus('‚ùå API connection failed', 'error');
                });
        });
    </script>
</body>
</html>